{"ast":null,"code":"\"use strict\";\n\nvar httpProxy = require(\"http-proxy\");\n\nvar utils = require(\"./utils\");\n\nvar proxyUtils = require(\"./proxy-utils\");\n\nvar Immutable = require(\"immutable\");\n\nvar Map = require(\"immutable\").Map;\n\nvar List = require(\"immutable\").List;\n/**\n * Default options that are passed along to http-proxy\n */\n\n\nvar defaultHttpProxyOptions = Map({\n  /**\n   * This ensures targets are more likely to\n   * accept each request\n   */\n  changeOrigin: true,\n\n  /**\n   * This handles redirects\n   */\n  autoRewrite: true,\n\n  /**\n   * This allows our self-signed certs to be used for development\n   */\n  secure: false,\n  ws: true\n});\nvar defaultCookieOptions = Map({\n  stripDomain: true\n});\nvar ProxyOption = Immutable.Record({\n  route: \"\",\n  target: \"\",\n  rewriteRules: true,\n\n  /**\n   * Functions to be called on proxy request\n   * with args [proxyReq, req, res, options]\n   */\n  proxyReq: List([]),\n\n  /**\n   * Functions to be called on proxy response\n   * with args [proxyRes, req, res]\n   */\n  proxyRes: List([]),\n\n  /**\n   * Functions to be called on proxy response\n   * with args [proxyReq, req, socket, options, head]\n   */\n  proxyReqWs: List([]),\n  errHandler: undefined,\n  url: Map({}),\n  proxyOptions: Map(defaultHttpProxyOptions),\n  cookies: Map(defaultCookieOptions),\n  ws: false,\n  middleware: List([]),\n  reqHeaders: undefined\n});\n/**\n * @param {BrowserSync} bs\n * @param {String} scripts\n * @returns {*}\n */\n\nmodule.exports = function createProxyServer(bs) {\n  var opt = new ProxyOption().mergeDeep(bs.options.get(\"proxy\"));\n  var proxy = httpProxy.createProxyServer(opt.get(\"proxyOptions\").set(\"target\", opt.get(\"target\")).toJS());\n  var target = opt.get(\"target\");\n  var proxyReq = getProxyReqFunctions(opt.get(\"proxyReq\"), opt, bs);\n  var proxyRes = getProxyResFunctions(opt.get(\"proxyRes\"), opt);\n  var proxyResWs = opt.get(\"proxyReqWs\");\n  bs.options = bs.options.update(\"middleware\", function (mw) {\n    return mw.concat({\n      id: \"Browsersync Proxy\",\n      route: opt.get(\"route\"),\n      handle: function (req, res) {\n        proxy.web(req, res, {\n          target: target\n        });\n      }\n    });\n  });\n  var app = utils.getBaseApp(bs);\n  /**\n   * @type {*|{server, app}}\n   */\n\n  var browserSyncServer = utils.getServer(app, bs.options);\n  browserSyncServer.proxy = proxy;\n\n  if (opt.get(\"ws\")) {\n    // debug(`+ ws upgrade for: ${x.get(\"target\")}`);\n    browserSyncServer.server.on(\"upgrade\", function (req, socket, head) {\n      proxy.ws(req, socket, head);\n    });\n  }\n  /**\n   * Add any user provided functions for proxyReq, proxyReqWs and proxyRes\n   */\n\n\n  applyFns(\"proxyReq\", proxyReq);\n  applyFns(\"proxyRes\", proxyRes);\n  applyFns(\"proxyReqWs\", proxyResWs);\n  /**\n   * Handle Proxy errors\n   */\n\n  proxy.on(\"error\", function (err) {\n    if (typeof opt.get(\"errHandler\") === \"function\") {\n      opt.get(\"errHandler\").call(null, err);\n    }\n  });\n  /**\n   * Apply functions to proxy events\n   * @param {string} name - the name of the http-proxy event\n   * @param {Array} fns - functions to call on each event\n   */\n\n  function applyFns(name, fns) {\n    if (!List.isList(fns)) fns = [fns];\n    proxy.on(name, function () {\n      var args = arguments;\n      fns.forEach(function (fn) {\n        if (typeof fn === \"function\") {\n          fn.apply(null, args);\n        }\n      });\n    });\n  }\n\n  return browserSyncServer;\n};\n/**\n * @param resFns\n * @returns {*}\n */\n\n\nfunction getProxyResFunctions(resFns, opt) {\n  if (opt.getIn([\"cookies\", \"stripDomain\"])) {\n    return resFns.push(proxyUtils.checkCookies);\n  }\n\n  return resFns;\n}\n/**\n * @param reqFns\n * @returns {*}\n */\n\n\nfunction getProxyReqFunctions(reqFns, opt, bs) {\n  var reqHeaders = opt.getIn([\"reqHeaders\"]);\n\n  if (!reqHeaders) {\n    return reqFns;\n  }\n  /**\n   * Back-compat for old `reqHeaders` option here a\n   * function was given that returned an object\n   * where key:value was header-name:header-value\n   * This didn't really work as it clobbered all other headers,\n   * but it remains for the unlucky few who used it.\n   */\n\n\n  if (typeof reqHeaders === \"function\") {\n    var output = reqHeaders.call(bs, opt.toJS());\n\n    if (Object.keys(output).length) {\n      return reqFns.concat(function (proxyReq) {\n        Object.keys(output).forEach(function (key) {\n          proxyReq.setHeader(key, output[key]);\n        });\n      });\n    }\n  }\n  /**\n   * Now, if {key:value} given, set the each header\n   *\n   * eg: reqHeaders: {\n   *     'is-dev': 'true'\n   * }\n   */\n\n\n  if (Map.isMap(reqHeaders)) {\n    return reqFns.concat(function (proxyReq) {\n      reqHeaders.forEach(function (value, key) {\n        proxyReq.setHeader(key, value);\n      });\n    });\n  }\n\n  return reqFns;\n}","map":{"version":3,"mappings":"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","names":["httpProxy","require","utils","proxyUtils","Immutable","Map","List","defaultHttpProxyOptions","changeOrigin","autoRewrite","secure","ws","defaultCookieOptions","stripDomain","ProxyOption","Record","route","target","rewriteRules","proxyReq","proxyRes","proxyReqWs","errHandler","undefined","url","proxyOptions","cookies","middleware","reqHeaders","module","exports","createProxyServer","bs","opt","mergeDeep","options","get","proxy","set","toJS","getProxyReqFunctions","getProxyResFunctions","proxyResWs","update","mw","concat","id","handle","req","res","web","app","getBaseApp","browserSyncServer","getServer","server","on","socket","head","applyFns","err","call","name","fns","isList","args","arguments","forEach","fn","apply","resFns","getIn","push","checkCookies","reqFns","output","Object","keys","length","key","setHeader","isMap","value"],"sources":["../../lib/server/proxy-server.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}