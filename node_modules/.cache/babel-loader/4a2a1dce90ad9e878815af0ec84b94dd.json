{"ast":null,"code":"\"use strict\";\n\nvar connectUtils = require(\"./connect-utils\");\n\nvar config = require(\"./config\");\n\nvar lrSnippet = require(\"resp-modifier\");\n\nvar path = require(\"path\");\n\nvar _ = require(\"./lodash.custom\");\n\nvar utils = require(\"./utils\");\n\nvar fs = require(\"fs\");\n\nvar path = require(\"path\");\n/**\n * Utils for snippet injection\n */\n\n\nvar snippetUtils = {\n  /**\n   * @param {String} url\n   * @param {Array} excludeList\n   * @returns {boolean}\n   */\n  isExcluded: function (url, excludeList) {\n    var extension = path.extname(url);\n\n    if (extension) {\n      if (~url.indexOf(\"?\")) {\n        return true;\n      }\n\n      extension = extension.slice(1);\n      return _.includes(excludeList, extension);\n    }\n\n    return false;\n  },\n\n  /**\n   * @param {String} snippet\n   * @param {Object} options\n   * @returns {{match: RegExp, fn: Function}}\n   */\n  getRegex: function (snippet, options) {\n    var fn = options.getIn([\"rule\", \"fn\"]);\n    return {\n      match: options.getIn([\"rule\", \"match\"]),\n      fn: function (req, res, match) {\n        return fn.apply(null, [snippet, match]);\n      },\n      once: true,\n      id: \"bs-snippet\"\n    };\n  },\n  getSnippetMiddleware: function (snippet, options, rewriteRules) {\n    return lrSnippet.create(snippetUtils.getRules(snippet, options, rewriteRules));\n  },\n  getRules: function (snippet, options, rewriteRules) {\n    var rules = [snippetUtils.getRegex(snippet, options)];\n\n    if (rewriteRules) {\n      rules = rules.concat(rewriteRules);\n    }\n\n    return {\n      rules: rules,\n      blacklist: utils.arrayify(options.get(\"blacklist\")),\n      whitelist: utils.arrayify(options.get(\"whitelist\"))\n    };\n  },\n\n  /**\n   * @param {Object} req\n   * @param {Array} [excludeList]\n   * @returns {Object}\n   */\n  isOldIe: function (excludeList) {\n    return function (req, res, next) {\n      var ua = req.headers[\"user-agent\"];\n      var match = /MSIE (\\d)\\.\\d/.exec(ua);\n\n      if (match) {\n        if (parseInt(match[1], 10) < 9) {\n          if (!snippetUtils.isExcluded(req.url, excludeList)) {\n            req.headers[\"accept\"] = \"text/html\";\n          }\n        }\n      }\n\n      next();\n    };\n  },\n\n  /**\n   * @param {Number} port\n   * @param {BrowserSync.options} options\n   * @returns {String}\n   */\n  getClientJs: function (port, options) {\n    return function () {\n      var script = options.get(\"minify\") ? \"index.min.js\" : \"index.js\";\n      var client = fs.readFileSync(require.resolve(\"browser-sync-client/dist/\" + script), \"utf8\");\n      return [connectUtils.socketConnector(options), client].join(\";\\n\");\n    };\n  }\n};\nmodule.exports.utils = snippetUtils;","map":{"version":3,"mappings":"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","names":["connectUtils","require","config","lrSnippet","path","_","utils","fs","snippetUtils","isExcluded","url","excludeList","extension","extname","indexOf","slice","includes","getRegex","snippet","options","fn","getIn","match","req","res","apply","once","id","getSnippetMiddleware","rewriteRules","create","getRules","rules","concat","blacklist","arrayify","get","whitelist","isOldIe","next","ua","headers","exec","parseInt","getClientJs","port","script","client","readFileSync","resolve","socketConnector","join","module","exports"],"sources":["../lib/snippet.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}