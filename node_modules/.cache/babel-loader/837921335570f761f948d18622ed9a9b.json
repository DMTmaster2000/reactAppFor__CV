{"ast":null,"code":"var http = require(\"http\");\n\nvar fs = require(\"fs\");\n\nvar path = require(\"path\");\n\nvar config = require(\"./config\");\n\nvar svg = publicFile(config.defaults.public.svg);\nvar indexPage = publicFile(config.defaults.indexPage); //var css         = publicFile(config.defaults.public.css);\n\nvar header = staticFile(config.defaults.components.header);\nvar footer = staticFile(config.defaults.components.footer);\n\nvar zlib = require(\"zlib\");\n/**\n * @param {UI} ui\n * @returns {*}\n */\n\n\nfunction startServer(ui) {\n  var connect = ui.bs.utils.connect;\n  var serveStatic = ui.bs.utils.serveStatic;\n  /**\n   * Create a connect server\n   */\n\n  var app = connect();\n  var socketJs = getSocketJs(ui);\n  var jsFilename = \"/\" + md5(socketJs, 10) + \".js\"; //var cssFilename = \"/\" + md5(css, 10)   + \".css\";\n\n  /**\n   * Create a single big file with all deps\n   */\n  //app.use(serveFile(jsFilename, \"js\", socketJs));\n\n  app.use(serveFile(config.defaults.socketJs, \"js\", socketJs)); // also serve for convenience/testing\n\n  app.use(serveFile(config.defaults.pagesConfig, \"js\", ui.pagesConfig)); //\n\n  app.use(serveFile(config.defaults.clientJs, \"js\", ui.clientJs));\n  /**\n   * Add any markup from plugins/hooks/templates\n   */\n\n  insertPageMarkupFromHooks(app, ui.pages, indexPage.replace(\"%pageMarkup%\", ui.pageMarkup).replace(\"%templates%\", ui.templates).replace(\"%svg%\", svg).replace(\"%header%\", header).replace(/%footer%/g, footer));\n  /**\n   * gzip css\n   */\n  //app.use(serveFile(cssFilename, \"css\", css));\n\n  app.use(serveStatic(path.join(__dirname, \"../public\")));\n  /**\n   * all public dir as static\n   */\n\n  app.use(serveStatic(publicDir(\"\")));\n  /**\n   * History API fallback\n   */\n\n  app.use(require(\"connect-history-api-fallback\"));\n  /**\n   * Development use\n   */\n\n  app.use(\"/node_modules\", serveStatic(packageDir(\"node_modules\")));\n  /**\n   * Return the server.\n   */\n\n  return {\n    server: http.createServer(app),\n    app: app\n  };\n}\n/**\n * @param app\n * @param pages\n * @param markup\n */\n\n\nfunction insertPageMarkupFromHooks(app, pages, markup) {\n  var cached;\n  app.use(function (req, res, next) {\n    if (req.url === \"/\" || pages[req.url.slice(1)]) {\n      res.writeHead(200, {\n        \"Content-Type\": \"text/html\",\n        \"Content-Encoding\": \"gzip\"\n      });\n\n      if (!cached) {\n        var buf = Buffer.from(markup, \"utf-8\");\n        zlib.gzip(buf, function (_, result) {\n          cached = result;\n          res.end(result);\n        });\n      } else {\n        res.end(cached);\n      }\n    } else {\n      next();\n    }\n  });\n}\n/**\n * Serve Gzipped files & cache them\n * @param app\n * @param all\n */\n\n\nvar gzipCache = {};\n\nfunction serveFile(path, type, string) {\n  var typemap = {\n    js: \"application/javascript\",\n    css: \"text/css\"\n  };\n  return function (req, res, next) {\n    if (req.url !== path) {\n      return next();\n    }\n\n    res.writeHead(200, {\n      \"Content-Type\": typemap[type],\n      \"Content-Encoding\": \"gzip\",\n      \"Cache-Control\": \"no-cache, no-store, must-revalidate\",\n      \"Expires\": 0,\n      \"Pragma\": \"no-cache\"\n    });\n\n    if (gzipCache[path]) {\n      return res.end(gzipCache[path]);\n    }\n\n    var buf = Buffer.from(string, \"utf-8\");\n    zlib.gzip(buf, function (_, result) {\n      gzipCache[path] = result;\n      res.end(result);\n    });\n  };\n}\n/**\n * @param cp\n * @returns {string}\n */\n\n\nfunction getSocketJs(cp) {\n  return [cp.bs.getExternalSocketConnector({\n    namespace: \"/browser-sync-cp\"\n  })].join(\";\");\n} ///**\n// * @returns {*}\n// * @param filepath\n// */\n//function fileContent (filepath) {\n//    return fs.readFileSync(require.resolve(filepath), \"utf8\");\n//}\n\n/**\n * @param src\n * @param length\n */\n\n\nfunction md5(src, length) {\n  var crypto = require(\"crypto\");\n\n  var hash = crypto.createHash(\"md5\").update(src, \"utf8\").digest(\"hex\");\n  return hash.slice(0, length);\n}\n/**\n * CWD directory helper for static dir\n * @param {string} filepath\n * @returns {string}\n */\n\n\nfunction publicDir(filepath) {\n  return path.join(__dirname, \"/../public\" + filepath) || \"\";\n}\n/**\n * @param {string} filepath\n * @returns {string|string}\n */\n\n\nfunction staticDir(filepath) {\n  return path.join(__dirname, \"/../static\" + filepath) || \"\";\n}\n/**\n * @param {string} filepath\n * @returns {*}\n */\n\n\nfunction publicFile(filepath) {\n  return fs.readFileSync(publicDir(filepath), \"utf-8\");\n}\n/**\n * @param filepath\n * @returns {*}\n */\n\n\nfunction staticFile(filepath) {\n  return fs.readFileSync(staticDir(filepath), \"utf-8\");\n}\n/**\n * @param {string} filepath\n * @returns {string}\n */\n\n\nfunction packageDir(filepath) {\n  return path.join(__dirname, \"/../\" + filepath);\n}\n\nmodule.exports = startServer;","map":{"version":3,"names":["http","require","fs","path","config","svg","publicFile","defaults","public","indexPage","header","staticFile","components","footer","zlib","startServer","ui","connect","bs","utils","serveStatic","app","socketJs","getSocketJs","jsFilename","md5","use","serveFile","pagesConfig","clientJs","insertPageMarkupFromHooks","pages","replace","pageMarkup","templates","join","__dirname","publicDir","packageDir","server","createServer","markup","cached","req","res","next","url","slice","writeHead","buf","Buffer","from","gzip","_","result","end","gzipCache","type","string","typemap","js","css","cp","getExternalSocketConnector","namespace","src","length","crypto","hash","createHash","update","digest","filepath","staticDir","readFileSync","module","exports"],"sources":["/Users/johnberetty/node_modules/browser-sync-ui/lib/server.js"],"sourcesContent":["var http        = require(\"http\");\nvar fs          = require(\"fs\");\nvar path        = require(\"path\");\nvar config      = require(\"./config\");\nvar svg         = publicFile(config.defaults.public.svg);\nvar indexPage   = publicFile(config.defaults.indexPage);\n//var css         = publicFile(config.defaults.public.css);\nvar header      = staticFile(config.defaults.components.header);\nvar footer      = staticFile(config.defaults.components.footer);\nvar zlib        = require(\"zlib\");\n\n/**\n * @param {UI} ui\n * @returns {*}\n */\nfunction startServer(ui) {\n\n    var connect     = ui.bs.utils.connect;\n    var serveStatic = ui.bs.utils.serveStatic;\n\n    /**\n     * Create a connect server\n     */\n    var app         = connect();\n    var socketJs    = getSocketJs(ui);\n    var jsFilename  = \"/\" + md5(socketJs, 10) + \".js\";\n    //var cssFilename = \"/\" + md5(css, 10)   + \".css\";\n\n    /**\n     * Create a single big file with all deps\n     */\n    //app.use(serveFile(jsFilename, \"js\", socketJs));\n    app.use(serveFile(config.defaults.socketJs, \"js\", socketJs));\n\n    // also serve for convenience/testing\n    app.use(serveFile(config.defaults.pagesConfig, \"js\", ui.pagesConfig));\n\n    //\n    app.use(serveFile(config.defaults.clientJs, \"js\",    ui.clientJs));\n\n    /**\n     * Add any markup from plugins/hooks/templates\n     */\n    insertPageMarkupFromHooks(\n        app,\n        ui.pages,\n        indexPage\n            .replace(\"%pageMarkup%\", ui.pageMarkup)\n            .replace(\"%templates%\", ui.templates)\n            .replace(\"%svg%\", svg)\n            .replace(\"%header%\", header)\n            .replace(/%footer%/g, footer)\n    );\n\n    /**\n     * gzip css\n     */\n    //app.use(serveFile(cssFilename, \"css\", css));\n\n    app.use(serveStatic(path.join(__dirname, \"../public\")));\n\n    /**\n     * all public dir as static\n     */\n    app.use(serveStatic(publicDir(\"\")));\n\n    /**\n     * History API fallback\n     */\n    app.use(require(\"connect-history-api-fallback\"));\n\n    /**\n     * Development use\n     */\n    app.use(\"/node_modules\", serveStatic(packageDir(\"node_modules\")));\n\n    /**\n     * Return the server.\n     */\n    return {\n        server: http.createServer(app),\n        app: app\n    };\n}\n\n/**\n * @param app\n * @param pages\n * @param markup\n */\nfunction insertPageMarkupFromHooks(app, pages, markup) {\n\n    var cached;\n\n    app.use(function (req, res, next) {\n\n        if (req.url === \"/\" || pages[req.url.slice(1)]) {\n            res.writeHead(200, {\"Content-Type\": \"text/html\", \"Content-Encoding\": \"gzip\"});\n            if (!cached) {\n                var buf = Buffer.from(markup, \"utf-8\");\n                zlib.gzip(buf, function (_, result) {\n                    cached = result;\n                    res.end(result);\n                });\n            } else {\n                res.end(cached);\n            }\n        } else {\n            next();\n        }\n    });\n}\n\n/**\n * Serve Gzipped files & cache them\n * @param app\n * @param all\n */\nvar gzipCache = {};\nfunction serveFile(path, type, string) {\n    var typemap = {\n        js:  \"application/javascript\",\n        css: \"text/css\"\n    };\n    return function (req, res, next) {\n        if (req.url !== path) {\n            return next();\n        }\n\n        res.writeHead(200, {\n            \"Content-Type\": typemap[type],\n            \"Content-Encoding\": \"gzip\",\n            \"Cache-Control\": \"no-cache, no-store, must-revalidate\",\n            \"Expires\": 0,\n            \"Pragma\": \"no-cache\"\n        });\n\n        if (gzipCache[path]) {\n            return res.end(gzipCache[path]);\n        }\n        var buf = Buffer.from(string, \"utf-8\");\n        zlib.gzip(buf, function (_, result) {\n            gzipCache[path] = result;\n            res.end(result);\n        });\n    };\n}\n\n\n/**\n * @param cp\n * @returns {string}\n */\nfunction getSocketJs (cp) {\n\n    return [\n        cp.bs.getExternalSocketConnector({namespace: \"/browser-sync-cp\"})\n    ].join(\";\");\n}\n\n///**\n// * @returns {*}\n// * @param filepath\n// */\n//function fileContent (filepath) {\n//    return fs.readFileSync(require.resolve(filepath), \"utf8\");\n//}\n\n/**\n * @param src\n * @param length\n */\nfunction md5(src, length) {\n    var crypto = require(\"crypto\");\n    var hash   = crypto.createHash(\"md5\").update(src, \"utf8\").digest(\"hex\");\n    return hash.slice(0, length);\n}\n\n/**\n * CWD directory helper for static dir\n * @param {string} filepath\n * @returns {string}\n */\nfunction publicDir (filepath) {\n    return path.join(__dirname, \"/../public\" + filepath) || \"\";\n}\n\n/**\n * @param {string} filepath\n * @returns {string|string}\n */\nfunction staticDir (filepath) {\n    return path.join(__dirname, \"/../static\" + filepath) || \"\";\n}\n\n/**\n * @param {string} filepath\n * @returns {*}\n */\nfunction publicFile(filepath) {\n    return fs.readFileSync(publicDir(filepath), \"utf-8\");\n}\n\n/**\n * @param filepath\n * @returns {*}\n */\nfunction staticFile(filepath) {\n    return fs.readFileSync(staticDir(filepath), \"utf-8\");\n}\n\n/**\n * @param {string} filepath\n * @returns {string}\n */\nfunction packageDir (filepath) {\n    return path.join(__dirname, \"/../\" + filepath);\n}\n\nmodule.exports = startServer;"],"mappings":"AAAA,IAAIA,IAAI,GAAUC,OAAO,CAAC,MAAD,CAAzB;;AACA,IAAIC,EAAE,GAAYD,OAAO,CAAC,IAAD,CAAzB;;AACA,IAAIE,IAAI,GAAUF,OAAO,CAAC,MAAD,CAAzB;;AACA,IAAIG,MAAM,GAAQH,OAAO,CAAC,UAAD,CAAzB;;AACA,IAAII,GAAG,GAAWC,UAAU,CAACF,MAAM,CAACG,QAAP,CAAgBC,MAAhB,CAAuBH,GAAxB,CAA5B;AACA,IAAII,SAAS,GAAKH,UAAU,CAACF,MAAM,CAACG,QAAP,CAAgBE,SAAjB,CAA5B,C,CACA;;AACA,IAAIC,MAAM,GAAQC,UAAU,CAACP,MAAM,CAACG,QAAP,CAAgBK,UAAhB,CAA2BF,MAA5B,CAA5B;AACA,IAAIG,MAAM,GAAQF,UAAU,CAACP,MAAM,CAACG,QAAP,CAAgBK,UAAhB,CAA2BC,MAA5B,CAA5B;;AACA,IAAIC,IAAI,GAAUb,OAAO,CAAC,MAAD,CAAzB;AAEA;AACA;AACA;AACA;;;AACA,SAASc,WAAT,CAAqBC,EAArB,EAAyB;EAErB,IAAIC,OAAO,GAAOD,EAAE,CAACE,EAAH,CAAMC,KAAN,CAAYF,OAA9B;EACA,IAAIG,WAAW,GAAGJ,EAAE,CAACE,EAAH,CAAMC,KAAN,CAAYC,WAA9B;EAEA;AACJ;AACA;;EACI,IAAIC,GAAG,GAAWJ,OAAO,EAAzB;EACA,IAAIK,QAAQ,GAAMC,WAAW,CAACP,EAAD,CAA7B;EACA,IAAIQ,UAAU,GAAI,MAAMC,GAAG,CAACH,QAAD,EAAW,EAAX,CAAT,GAA0B,KAA5C,CAVqB,CAWrB;;EAEA;AACJ;AACA;EACI;;EACAD,GAAG,CAACK,GAAJ,CAAQC,SAAS,CAACvB,MAAM,CAACG,QAAP,CAAgBe,QAAjB,EAA2B,IAA3B,EAAiCA,QAAjC,CAAjB,EAjBqB,CAmBrB;;EACAD,GAAG,CAACK,GAAJ,CAAQC,SAAS,CAACvB,MAAM,CAACG,QAAP,CAAgBqB,WAAjB,EAA8B,IAA9B,EAAoCZ,EAAE,CAACY,WAAvC,CAAjB,EApBqB,CAsBrB;;EACAP,GAAG,CAACK,GAAJ,CAAQC,SAAS,CAACvB,MAAM,CAACG,QAAP,CAAgBsB,QAAjB,EAA2B,IAA3B,EAAoCb,EAAE,CAACa,QAAvC,CAAjB;EAEA;AACJ;AACA;;EACIC,yBAAyB,CACrBT,GADqB,EAErBL,EAAE,CAACe,KAFkB,EAGrBtB,SAAS,CACJuB,OADL,CACa,cADb,EAC6BhB,EAAE,CAACiB,UADhC,EAEKD,OAFL,CAEa,aAFb,EAE4BhB,EAAE,CAACkB,SAF/B,EAGKF,OAHL,CAGa,OAHb,EAGsB3B,GAHtB,EAIK2B,OAJL,CAIa,UAJb,EAIyBtB,MAJzB,EAKKsB,OALL,CAKa,WALb,EAK0BnB,MAL1B,CAHqB,CAAzB;EAWA;AACJ;AACA;EACI;;EAEAQ,GAAG,CAACK,GAAJ,CAAQN,WAAW,CAACjB,IAAI,CAACgC,IAAL,CAAUC,SAAV,EAAqB,WAArB,CAAD,CAAnB;EAEA;AACJ;AACA;;EACIf,GAAG,CAACK,GAAJ,CAAQN,WAAW,CAACiB,SAAS,CAAC,EAAD,CAAV,CAAnB;EAEA;AACJ;AACA;;EACIhB,GAAG,CAACK,GAAJ,CAAQzB,OAAO,CAAC,8BAAD,CAAf;EAEA;AACJ;AACA;;EACIoB,GAAG,CAACK,GAAJ,CAAQ,eAAR,EAAyBN,WAAW,CAACkB,UAAU,CAAC,cAAD,CAAX,CAApC;EAEA;AACJ;AACA;;EACI,OAAO;IACHC,MAAM,EAAEvC,IAAI,CAACwC,YAAL,CAAkBnB,GAAlB,CADL;IAEHA,GAAG,EAAEA;EAFF,CAAP;AAIH;AAED;AACA;AACA;AACA;AACA;;;AACA,SAASS,yBAAT,CAAmCT,GAAnC,EAAwCU,KAAxC,EAA+CU,MAA/C,EAAuD;EAEnD,IAAIC,MAAJ;EAEArB,GAAG,CAACK,GAAJ,CAAQ,UAAUiB,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;IAE9B,IAAIF,GAAG,CAACG,GAAJ,KAAY,GAAZ,IAAmBf,KAAK,CAACY,GAAG,CAACG,GAAJ,CAAQC,KAAR,CAAc,CAAd,CAAD,CAA5B,EAAgD;MAC5CH,GAAG,CAACI,SAAJ,CAAc,GAAd,EAAmB;QAAC,gBAAgB,WAAjB;QAA8B,oBAAoB;MAAlD,CAAnB;;MACA,IAAI,CAACN,MAAL,EAAa;QACT,IAAIO,GAAG,GAAGC,MAAM,CAACC,IAAP,CAAYV,MAAZ,EAAoB,OAApB,CAAV;QACA3B,IAAI,CAACsC,IAAL,CAAUH,GAAV,EAAe,UAAUI,CAAV,EAAaC,MAAb,EAAqB;UAChCZ,MAAM,GAAGY,MAAT;UACAV,GAAG,CAACW,GAAJ,CAAQD,MAAR;QACH,CAHD;MAIH,CAND,MAMO;QACHV,GAAG,CAACW,GAAJ,CAAQb,MAAR;MACH;IACJ,CAXD,MAWO;MACHG,IAAI;IACP;EACJ,CAhBD;AAiBH;AAED;AACA;AACA;AACA;AACA;;;AACA,IAAIW,SAAS,GAAG,EAAhB;;AACA,SAAS7B,SAAT,CAAmBxB,IAAnB,EAAyBsD,IAAzB,EAA+BC,MAA/B,EAAuC;EACnC,IAAIC,OAAO,GAAG;IACVC,EAAE,EAAG,wBADK;IAEVC,GAAG,EAAE;EAFK,CAAd;EAIA,OAAO,UAAUlB,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;IAC7B,IAAIF,GAAG,CAACG,GAAJ,KAAY3C,IAAhB,EAAsB;MAClB,OAAO0C,IAAI,EAAX;IACH;;IAEDD,GAAG,CAACI,SAAJ,CAAc,GAAd,EAAmB;MACf,gBAAgBW,OAAO,CAACF,IAAD,CADR;MAEf,oBAAoB,MAFL;MAGf,iBAAiB,qCAHF;MAIf,WAAW,CAJI;MAKf,UAAU;IALK,CAAnB;;IAQA,IAAID,SAAS,CAACrD,IAAD,CAAb,EAAqB;MACjB,OAAOyC,GAAG,CAACW,GAAJ,CAAQC,SAAS,CAACrD,IAAD,CAAjB,CAAP;IACH;;IACD,IAAI8C,GAAG,GAAGC,MAAM,CAACC,IAAP,CAAYO,MAAZ,EAAoB,OAApB,CAAV;IACA5C,IAAI,CAACsC,IAAL,CAAUH,GAAV,EAAe,UAAUI,CAAV,EAAaC,MAAb,EAAqB;MAChCE,SAAS,CAACrD,IAAD,CAAT,GAAkBmD,MAAlB;MACAV,GAAG,CAACW,GAAJ,CAAQD,MAAR;IACH,CAHD;EAIH,CArBD;AAsBH;AAGD;AACA;AACA;AACA;;;AACA,SAAS/B,WAAT,CAAsBuC,EAAtB,EAA0B;EAEtB,OAAO,CACHA,EAAE,CAAC5C,EAAH,CAAM6C,0BAAN,CAAiC;IAACC,SAAS,EAAE;EAAZ,CAAjC,CADG,EAEL7B,IAFK,CAEA,GAFA,CAAP;AAGH,C,CAED;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AACA,SAASV,GAAT,CAAawC,GAAb,EAAkBC,MAAlB,EAA0B;EACtB,IAAIC,MAAM,GAAGlE,OAAO,CAAC,QAAD,CAApB;;EACA,IAAImE,IAAI,GAAKD,MAAM,CAACE,UAAP,CAAkB,KAAlB,EAAyBC,MAAzB,CAAgCL,GAAhC,EAAqC,MAArC,EAA6CM,MAA7C,CAAoD,KAApD,CAAb;EACA,OAAOH,IAAI,CAACrB,KAAL,CAAW,CAAX,EAAcmB,MAAd,CAAP;AACH;AAED;AACA;AACA;AACA;AACA;;;AACA,SAAS7B,SAAT,CAAoBmC,QAApB,EAA8B;EAC1B,OAAOrE,IAAI,CAACgC,IAAL,CAAUC,SAAV,EAAqB,eAAeoC,QAApC,KAAiD,EAAxD;AACH;AAED;AACA;AACA;AACA;;;AACA,SAASC,SAAT,CAAoBD,QAApB,EAA8B;EAC1B,OAAOrE,IAAI,CAACgC,IAAL,CAAUC,SAAV,EAAqB,eAAeoC,QAApC,KAAiD,EAAxD;AACH;AAED;AACA;AACA;AACA;;;AACA,SAASlE,UAAT,CAAoBkE,QAApB,EAA8B;EAC1B,OAAOtE,EAAE,CAACwE,YAAH,CAAgBrC,SAAS,CAACmC,QAAD,CAAzB,EAAqC,OAArC,CAAP;AACH;AAED;AACA;AACA;AACA;;;AACA,SAAS7D,UAAT,CAAoB6D,QAApB,EAA8B;EAC1B,OAAOtE,EAAE,CAACwE,YAAH,CAAgBD,SAAS,CAACD,QAAD,CAAzB,EAAqC,OAArC,CAAP;AACH;AAED;AACA;AACA;AACA;;;AACA,SAASlC,UAAT,CAAqBkC,QAArB,EAA+B;EAC3B,OAAOrE,IAAI,CAACgC,IAAL,CAAUC,SAAV,EAAqB,SAASoC,QAA9B,CAAP;AACH;;AAEDG,MAAM,CAACC,OAAP,GAAiB7D,WAAjB"},"metadata":{},"sourceType":"script"}