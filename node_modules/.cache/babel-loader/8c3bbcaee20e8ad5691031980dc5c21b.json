{"ast":null,"code":"#!/usr/bin/env node\n\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar startOpts = require(\"../cli-options/opts.start.json\");\n\nvar reloadOpts = require(\"../cli-options/opts.reload.json\");\n\nvar recipeOpts = require(\"../cli-options/opts.recipe.json\");\n\nvar pkg = require(\"../package.json\");\n\nvar utils = require(\"./utils\");\n\nvar path_1 = require(\"path\");\n\nvar fs_1 = require(\"fs\");\n\nvar logger_1 = require(\"./logger\");\n\nvar eazy_logger_1 = require(\"eazy-logger\");\n\nvar cli_options_1 = require(\"./cli/cli-options\");\n\nvar BsErrorLevels;\n\n(function (BsErrorLevels) {\n  BsErrorLevels[\"Fatal\"] = \"Fatal\";\n})(BsErrorLevels = exports.BsErrorLevels || (exports.BsErrorLevels = {}));\n\nvar BsErrorTypes;\n\n(function (BsErrorTypes) {\n  BsErrorTypes[\"PathNotFound\"] = \"PathNotFound\";\n  BsErrorTypes[\"HostAndListenIncompatible\"] = \"HostAndListenIncompatible\";\n})(BsErrorTypes = exports.BsErrorTypes || (exports.BsErrorTypes = {}));\n/**\n * Handle cli input\n */\n\n\nif (!module.parent) {\n  runFromCli();\n}\n\nfunction runFromCli() {\n  var yargs = require(\"yargs\").command(\"start\", \"Start the server\").command(\"init\", \"Create a configuration file\").command(\"reload\", \"Send a reload event over HTTP protocol\").command(\"recipe\", \"Generate the files for a recipe\").version(pkg.version).epilogue([\"For help running a certain command, type <command> --help\", \"  $0 start --help\", \"\", \"You can run a static server by providing a path(s) directly\", \"  $0 app/src app/tmp\", \"\", \"If the directory contains a 'index.html' file, you can omit any input\", \"  $0\", \"\", \"You can run the proxy in this manner too\", \"  $0 https://example.com\", \"\", \"To run a proxy, whilst also serving static files\", eazy_logger_1.compile(\"  $0 https://example.com htdocs/themes/example\")].join(\"\\n\"));\n\n  var argv = yargs.argv;\n  var input = argv._;\n  var command = input[0];\n  var valid = [\"start\", \"init\", \"reload\", \"recipe\"];\n\n  if (valid.indexOf(command) > -1) {\n    return handleIncoming(command, yargs.reset());\n  }\n\n  if (input.length) {\n    return handleNoCommand(argv, input, yargs);\n  }\n\n  if (fs_1.existsSync(\"index.html\")) {\n    return handleNoCommand(argv, [\".\"], yargs);\n  }\n\n  yargs.showHelp();\n}\n/**\n * Feature: If no command was specified, try to do the 'right thing'\n *\n * If paths were given, start the server\n *          eg: browser-sync app/code app/design\n * is equal to: browser-sync start --server app/code app/design\n *\n *           eg: browser-sync http://example.com\n * is equal to: browser-sync start --proxy http://example.com\n *\n *           eg: browser-sync http://example.com themes/example\n * is equal to: browser-sync start --proxy http://example.com --ss themes/example\n *\n * @param argv\n * @param input\n * @returns {any}\n */\n\n\nfunction handleNoCommand(argv, input, yargs) {\n  var processed = processStart(yargs);\n  var paths = input.map(function (path) {\n    var resolved = path_1.resolve(path);\n    var isUrl = /^https?:\\/\\//.test(path);\n    return {\n      isUrl: isUrl,\n      userInput: path,\n      resolved: resolved,\n      errors: isUrl ? [] : pathErrors(path, resolved)\n    };\n  });\n  var withErrors = paths.filter(function (item) {\n    return item.errors.length;\n  });\n  var withoutErrors = paths.filter(function (item) {\n    return item.errors.length === 0;\n  });\n\n  if (withErrors.length) {\n    withErrors.forEach(function (item) {\n      logger_1.logger.unprefixed(\"error\", cli_options_1.printErrors(item.errors));\n    });\n    return process.exit(1);\n  }\n\n  var serveStaticPaths = withoutErrors.filter(function (item) {\n    return item.isUrl === false;\n  }).map(function (item) {\n    return item.resolved;\n  });\n  var urls = withoutErrors.filter(function (item) {\n    return item.isUrl === true;\n  }).map(function (item) {\n    return item.userInput;\n  });\n  /**\n   * If a URL was given, switch to proxy mode and use\n   * any other paths as serveStatic options\n   */\n\n  if (urls.length) {\n    var proxy = urls[0];\n\n    var config_1 = __assign({}, processed, {\n      proxy: proxy,\n      serveStatic: serveStaticPaths\n    });\n\n    return handleCli({\n      cli: {\n        flags: config_1,\n        input: [\"start\"]\n      }\n    });\n  }\n  /**\n   * if NO urls were given switch directly to server mode\n   * @type {{server: {baseDir: any}}}\n   */\n\n\n  var config = __assign({}, processed, {\n    server: {\n      baseDir: serveStaticPaths\n    }\n  });\n\n  return handleCli({\n    cli: {\n      flags: config,\n      input: [\"start\"]\n    }\n  });\n}\n/**\n * @param {{cli: object, [whitelist]: array, [cb]: function}} opts\n * @returns {*}\n */\n\n\nfunction handleCli(opts) {\n  opts.cb = opts.cb || utils.defaultCallback;\n\n  var m = require(\"./cli/command.\" + opts.cli.input[0]);\n\n  if (m.default) {\n    return m.default(opts);\n  }\n\n  return m(opts);\n}\n\nexports.default = handleCli;\n\nfunction processStart(yargs) {\n  return yargs.usage(\"Usage: $0 start [options]\").options(startOpts).example(\"$0 start -s app\", \"- Use the App directory to serve files\").example(\"$0 start -p www.bbc.co.uk\", \"- Proxy an existing website\").default(\"cwd\", function () {\n    return process.cwd();\n  }).help().argv;\n}\n/**\n * @param {string} command\n * @param {object} yargs\n * @param cwd\n */\n\n\nfunction handleIncoming(command, yargs) {\n  var out;\n\n  if (command === \"start\") {\n    out = processStart(yargs);\n  }\n\n  if (command === \"init\") {\n    out = yargs.usage(\"Usage: $0 init\").example(\"$0 init\").default(\"cwd\", function () {\n      return process.cwd();\n    }).help().argv;\n  }\n\n  if (command === \"reload\") {\n    out = yargs.usage(\"Usage: $0 reload\").options(reloadOpts).example(\"$0 reload\").example(\"$0 reload --port 4000\").default(\"cwd\", function () {\n      return process.cwd();\n    }).help().argv;\n  }\n\n  if (command === \"recipe\") {\n    out = yargs.usage(\"Usage: $0 recipe <recipe-name>\").option(recipeOpts).example(\"$0 recipe ls\", \"list the recipes\").example(\"$0 recipe gulp.sass\", \"use the gulp.sass recipe\").default(\"cwd\", function () {\n      return process.cwd();\n    }).help().argv;\n  }\n\n  if (out.help) {\n    return yargs.showHelp();\n  }\n\n  handleCli({\n    cli: {\n      flags: out,\n      input: out._\n    }\n  });\n}\n\nfunction pathErrors(input, resolved) {\n  if (!fs_1.existsSync(resolved)) {\n    return [{\n      type: BsErrorTypes.PathNotFound,\n      level: BsErrorLevels.Fatal,\n      errors: [{\n        error: new Error(\"Path not found: \" + input),\n        meta: function () {\n          return [\"Your Input:    {yellow:\" + input + \"}\", \"CWD:           {yellow:\" + process.cwd() + \"}\", \"Resolved to:   {yellow:\" + resolved + \"}\"];\n        }\n      }]\n    }];\n  }\n\n  return [];\n}","map":{"version":3,"mappings":"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","names":["startOpts","require","reloadOpts","recipeOpts","pkg","BsErrorLevels","exports","BsErrorTypes","module","parent","runFromCli","yargs","command","version","epilogue","eazy_logger_1","join","argv","input","_","valid","indexOf","handleIncoming","reset","length","handleNoCommand","fs_1","showHelp","processed","processStart","paths","map","resolved","path_1","path","isUrl","test","userInput","errors","pathErrors","withErrors","filter","withoutErrors","forEach","logger_1","unprefixed","cli_options_1","item","process","exit","serveStaticPaths","urls","proxy","config_1","serveStatic","handleCli","cli","flags","config","server","baseDir","opts","cb","utils","defaultCallback","m","default","usage","options","example","cwd","help","out","option","type","PathNotFound","level","Fatal","error","Error","meta"],"sources":["../lib/bin.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}