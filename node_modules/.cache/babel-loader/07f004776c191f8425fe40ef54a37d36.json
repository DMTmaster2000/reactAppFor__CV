{"ast":null,"code":"var Immutable = require(\"immutable\");\n\nmodule.exports.init = function (ui) {\n  var optPath = [\"network-throttle\"];\n  var serverOptPath = optPath.concat([\"servers\"]);\n  var listenHost = ui.options.get(\"listen\");\n  ui.servers = {};\n  ui.setOptionIn(optPath, Immutable.fromJS({\n    name: \"network-throttle\",\n    title: \"Network Throttle\",\n    active: false,\n    targets: require(\"./targets\")\n  }));\n  ui.setOptionIn(serverOptPath, Immutable.Map({}));\n  /**\n   * @param input\n   * @returns {number}\n   */\n\n  function getPortArg(input) {\n    input = input.trim();\n\n    if (input.length && input.match(/\\d{3,5}/)) {\n      input = parseInt(input, 10);\n    } else {\n      input = ui.bs.options.get(\"port\") + 1;\n    }\n\n    return input;\n  }\n  /**\n   * @returns {string}\n   */\n\n\n  function getTargetUrl() {\n    return require(\"url\").parse(ui.bs.options.getIn([\"urls\", \"local\"]));\n  }\n\n  var methods = {\n    /**\n     * @param data\n     */\n    \"server:create\": function (data) {\n      data.port = getPortArg(data.port);\n\n      data.cb = data.cb || function () {\n        /* noop */\n      };\n      /**\n       * @param opts\n       */\n\n\n      function saveThrottleInfo(opts) {\n        var urls = getUrls(ui.bs.options.set(\"port\", opts.port).toJS());\n        ui.setOptionIn(serverOptPath.concat([opts.port]), Immutable.fromJS({\n          urls: urls,\n          speed: opts.speed\n        }));\n        setTimeout(function () {\n          ui.socket.emit(\"ui:network-throttle:update\", {\n            servers: ui.getOptionIn(serverOptPath).toJS(),\n            event: \"server:create\"\n          });\n          ui.servers[opts.port] = opts.server;\n          data.cb(null, opts);\n        }, 300);\n      }\n      /**\n       * @param err\n       * @param port\n       */\n\n\n      function createThrottle(err, port) {\n        var target = getTargetUrl();\n        var args = {\n          port: port,\n          target: target,\n          speed: data.speed\n        };\n\n        if (ui.bs.getOption(\"scheme\") === \"https\") {\n          var httpsOpts = require(\"browser-sync/lib/server/utils\").getHttpsOptions(ui.bs.options);\n\n          args.key = httpsOpts.key;\n          args.cert = httpsOpts.cert;\n        }\n\n        args.server = require(\"./throttle-server\")(args, listenHost);\n\n        require('server-destroy')(args.server);\n\n        args.server.listen(port, listenHost);\n        saveThrottleInfo(args);\n      }\n      /**\n       * Try for a free port\n       */\n\n\n      ui.bs.utils.portscanner.findAPortNotInUse(data.port, data.port + 100, listenHost || \"127.0.0.1\", function (err, port) {\n        if (err) {\n          return createThrottle(err);\n        } else {\n          createThrottle(null, port);\n        }\n      });\n    },\n\n    /**\n     * @param data\n     */\n    \"server:destroy\": function (data) {\n      if (ui.servers[data.port]) {\n        ui.servers[data.port].destroy();\n        ui.setMany(function (item) {\n          item.deleteIn(serverOptPath.concat([parseInt(data.port, 10)]));\n        });\n        delete ui.servers[data.port];\n      }\n\n      ui.socket.emit(\"ui:network-throttle:update\", {\n        servers: ui.getOptionIn(serverOptPath).toJS(),\n        event: \"server:destroy\"\n      });\n    },\n\n    /**\n     * @param event\n     */\n    event: function (event) {\n      methods[event.event](event.data);\n    }\n  };\n  return methods;\n};\n/**\n * Get local + external urls with a different port\n * @param opts\n * @returns {List<T>|List<any>}\n */\n\n\nfunction getUrls(opts) {\n  var list = [];\n\n  var bsLocal = require(\"url\").parse(opts.urls.local);\n\n  list.push([bsLocal.protocol + \"//\", bsLocal.hostname, \":\", opts.port].join(\"\"));\n\n  if (opts.urls.external) {\n    var external = require(\"url\").parse(opts.urls.external);\n\n    list.push([bsLocal.protocol + \"//\", external.hostname, \":\", opts.port].join(\"\"));\n  }\n\n  return Immutable.List(list);\n}","map":{"version":3,"names":["Immutable","require","module","exports","init","ui","optPath","serverOptPath","concat","listenHost","options","get","servers","setOptionIn","fromJS","name","title","active","targets","Map","getPortArg","input","trim","length","match","parseInt","bs","getTargetUrl","parse","getIn","methods","data","port","cb","saveThrottleInfo","opts","urls","getUrls","set","toJS","speed","setTimeout","socket","emit","getOptionIn","event","server","createThrottle","err","target","args","getOption","httpsOpts","getHttpsOptions","key","cert","listen","utils","portscanner","findAPortNotInUse","destroy","setMany","item","deleteIn","list","bsLocal","local","push","protocol","hostname","join","external","List"],"sources":["/Users/johnberetty/node_modules/browser-sync-ui/lib/plugins/network-throttle/network-throttle.js"],"sourcesContent":["var Immutable = require(\"immutable\");\n\nmodule.exports.init = function (ui) {\n\n    var optPath = [\"network-throttle\"];\n    var serverOptPath = optPath.concat([\"servers\"]);\n    var listenHost = ui.options.get(\"listen\");\n    ui.servers  = {};\n\n    ui.setOptionIn(optPath, Immutable.fromJS({\n        name: \"network-throttle\",\n        title: \"Network Throttle\",\n        active: false,\n        targets: require(\"./targets\")\n    }));\n\n    ui.setOptionIn(serverOptPath, Immutable.Map({}));\n\n    /**\n     * @param input\n     * @returns {number}\n     */\n    function getPortArg(input) {\n        input = input.trim();\n        if (input.length && input.match(/\\d{3,5}/)) {\n            input = parseInt(input, 10);\n        } else {\n            input = ui.bs.options.get(\"port\") + 1;\n        }\n        return input;\n    }\n\n    /**\n     * @returns {string}\n     */\n    function getTargetUrl() {\n        return require(\"url\").parse(ui.bs.options.getIn([\"urls\", \"local\"]));\n    }\n\n    var methods = {\n        /**\n         * @param data\n         */\n        \"server:create\": function (data) {\n\n            data.port = getPortArg(data.port);\n            data.cb   = data.cb || function () { /* noop */};\n\n            /**\n             * @param opts\n             */\n            function saveThrottleInfo (opts) {\n\n                var urls = getUrls(ui.bs.options.set(\"port\", opts.port).toJS());\n\n                ui.setOptionIn(serverOptPath.concat([opts.port]), Immutable.fromJS({\n                    urls: urls,\n                    speed: opts.speed\n                }));\n\n                setTimeout(function () {\n\n                    ui.socket.emit(\"ui:network-throttle:update\", {\n                        servers: ui.getOptionIn(serverOptPath).toJS(),\n                        event: \"server:create\"\n                    });\n\n                    ui.servers[opts.port] = opts.server;\n\n                    data.cb(null, opts);\n\n                }, 300);\n\n            }\n\n            /**\n             * @param err\n             * @param port\n             */\n            function createThrottle (err, port) {\n\n                var target = getTargetUrl();\n\n                var args = {\n                    port: port,\n                    target: target,\n                    speed: data.speed\n                };\n\n                if (ui.bs.getOption(\"scheme\") === \"https\") {\n                    var httpsOpts = require(\"browser-sync/lib/server/utils\").getHttpsOptions(ui.bs.options);\n                    args.key  = httpsOpts.key;\n                    args.cert = httpsOpts.cert;\n                }\n\n                args.server = require(\"./throttle-server\")(args, listenHost);\n                require('server-destroy')(args.server);\n                args.server.listen(port, listenHost);\n\n                saveThrottleInfo(args);\n            }\n\n            /**\n             * Try for a free port\n             */\n            ui.bs.utils.portscanner.findAPortNotInUse(data.port, data.port + 100, (listenHost || \"127.0.0.1\"), function (err, port) {\n                if (err) {\n                    return createThrottle(err);\n                } else {\n                    createThrottle(null, port);\n                }\n            });\n        },\n        /**\n         * @param data\n         */\n        \"server:destroy\": function (data) {\n            if (ui.servers[data.port]) {\n                ui.servers[data.port].destroy();\n                ui.setMany(function (item) {\n                    item.deleteIn(serverOptPath.concat([parseInt(data.port, 10)]));\n                });\n                delete ui.servers[data.port];\n            }\n            ui.socket.emit(\"ui:network-throttle:update\", {\n                servers: ui.getOptionIn(serverOptPath).toJS(),\n                event: \"server:destroy\"\n            });\n        },\n        /**\n         * @param event\n         */\n        event: function (event) {\n            methods[event.event](event.data);\n        }\n    };\n\n    return methods;\n};\n\n/**\n * Get local + external urls with a different port\n * @param opts\n * @returns {List<T>|List<any>}\n */\nfunction getUrls (opts) {\n\n    var list    = [];\n\n    var bsLocal = require(\"url\").parse(opts.urls.local);\n\n    list.push([bsLocal.protocol + \"//\", bsLocal.hostname, \":\", opts.port].join(\"\"));\n\n    if (opts.urls.external) {\n        var external = require(\"url\").parse(opts.urls.external);\n        list.push([bsLocal.protocol + \"//\", external.hostname, \":\", opts.port].join(\"\"));\n    }\n\n    return Immutable.List(list);\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}