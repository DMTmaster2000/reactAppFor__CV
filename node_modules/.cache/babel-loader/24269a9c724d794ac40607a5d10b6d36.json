{"ast":null,"code":"\"use strict\";\n\nvar socket = require(\"socket.io\");\n\nvar utils = require(\"./server/utils\");\n/**\n * Plugin interface\n * @returns {*|function(this:exports)}\n */\n\n\nmodule.exports.plugin = function (server, clientEvents, bs) {\n  return exports.init(server, clientEvents, bs);\n};\n/**\n * @param {http.Server} server\n * @param clientEvents\n * @param {BrowserSync} bs\n */\n\n\nmodule.exports.init = function (server, clientEvents, bs) {\n  var emitter = bs.events;\n  var socketConfig = bs.options.get(\"socket\").toJS();\n\n  if (bs.options.get(\"mode\") === \"proxy\" && bs.options.getIn([\"proxy\", \"ws\"])) {\n    server = utils.getServer(null, bs.options).server;\n    server.listen(bs.options.getIn([\"socket\", \"port\"]));\n    bs.registerCleanupTask(function () {\n      server.close();\n    });\n  }\n\n  var socketIoConfig = socketConfig.socketIoOptions;\n  socketIoConfig.path = socketConfig.path;\n  var io = socket(server, socketIoConfig); // Override default namespace.\n\n  io.sockets = io.of(socketConfig.namespace);\n  io.set(\"heartbeat interval\", socketConfig.clients.heartbeatTimeout); // Breaking change was introduced https://socket.io/blog/socket-io-2-4-0/\n\n  io.origins(function (_, callback) {\n    callback(null, true);\n  });\n  /**\n   * Listen for new connections\n   */\n\n  io.sockets.on(\"connection\", handleConnection);\n  /**\n   * Handle each new connection\n   * @param {Object} client\n   */\n\n  function handleConnection(client) {\n    // set ghostmode callbacks\n    if (bs.options.get(\"ghostMode\")) {\n      addGhostMode(client);\n    }\n\n    client.emit(\"connection\", bs.options.toJS()); //todo - trim the amount of options sent to clients\n\n    emitter.emit(\"client:connected\", {\n      ua: client.handshake.headers[\"user-agent\"]\n    });\n  }\n  /**\n   * @param client\n   */\n\n\n  function addGhostMode(client) {\n    clientEvents.forEach(addEvent);\n\n    function addEvent(event) {\n      client.on(event, function (data) {\n        client.broadcast.emit(event, data);\n      });\n    }\n  }\n\n  return io;\n};","map":{"version":3,"mappings":"AAAA;;AAEA,IAAIA,MAAM,GAAGC,OAAO,CAAC,WAAD,CAApB;;AACA,IAAIC,KAAK,GAAGD,OAAO,CAAC,gBAAD,CAAnB;AAEA;;;;;;AAIAE,MAAM,CAACC,OAAP,CAAeC,MAAf,GAAwB,UAASC,MAAT,EAAiBC,YAAjB,EAA+BC,EAA/B,EAAiC;EACrD,OAAOJ,OAAO,CAACK,IAAR,CAAaH,MAAb,EAAqBC,YAArB,EAAmCC,EAAnC,CAAP;AACH,CAFD;AAIA;;;;;;;AAKAL,MAAM,CAACC,OAAP,CAAeK,IAAf,GAAsB,UAASH,MAAT,EAAiBC,YAAjB,EAA+BC,EAA/B,EAAiC;EACnD,IAAIE,OAAO,GAAGF,EAAE,CAACG,MAAjB;EAEA,IAAIC,YAAY,GAAGJ,EAAE,CAACK,OAAH,CAAWC,GAAX,CAAe,QAAf,EAAyBC,IAAzB,EAAnB;;EAEA,IACIP,EAAE,CAACK,OAAH,CAAWC,GAAX,CAAe,MAAf,MAA2B,OAA3B,IACAN,EAAE,CAACK,OAAH,CAAWG,KAAX,CAAiB,CAAC,OAAD,EAAU,IAAV,CAAjB,CAFJ,EAGE;IACEV,MAAM,GAAGJ,KAAK,CAACe,SAAN,CAAgB,IAAhB,EAAsBT,EAAE,CAACK,OAAzB,EAAkCP,MAA3C;IACAA,MAAM,CAACY,MAAP,CAAcV,EAAE,CAACK,OAAH,CAAWG,KAAX,CAAiB,CAAC,QAAD,EAAW,MAAX,CAAjB,CAAd;IACAR,EAAE,CAACW,mBAAH,CAAuB;MACnBb,MAAM,CAACc,KAAP;IACH,CAFD;EAGH;;EAED,IAAIC,cAAc,GAAGT,YAAY,CAACU,eAAlC;EACAD,cAAc,CAACE,IAAf,GAAsBX,YAAY,CAACW,IAAnC;EAEA,IAAIC,EAAE,GAAGxB,MAAM,CAACM,MAAD,EAASe,cAAT,CAAf,CAnBmD,CAqBnD;;EACAG,EAAE,CAACC,OAAH,GAAaD,EAAE,CAACE,EAAH,CAAMd,YAAY,CAACe,SAAnB,CAAb;EAEAH,EAAE,CAACI,GAAH,CAAO,oBAAP,EAA6BhB,YAAY,CAACiB,OAAb,CAAqBC,gBAAlD,EAxBmD,CA0BnD;;EACAN,EAAE,CAACO,OAAH,CAAW,UAACC,CAAD,EAAIC,QAAJ,EAAY;IACnBA,QAAQ,CAAC,IAAD,EAAO,IAAP,CAAR;EACH,CAFD;EAIA;;;;EAGAT,EAAE,CAACC,OAAH,CAAWS,EAAX,CAAc,YAAd,EAA4BC,gBAA5B;EAEA;;;;;EAIA,SAASA,gBAAT,CAA0BC,MAA1B,EAAgC;IAC5B;IACA,IAAI5B,EAAE,CAACK,OAAH,CAAWC,GAAX,CAAe,WAAf,CAAJ,EAAiC;MAC7BuB,YAAY,CAACD,MAAD,CAAZ;IACH;;IAEDA,MAAM,CAACE,IAAP,CAAY,YAAZ,EAA0B9B,EAAE,CAACK,OAAH,CAAWE,IAAX,EAA1B,EAN4B,CAMkB;;IAE9CL,OAAO,CAAC4B,IAAR,CAAa,kBAAb,EAAiC;MAC7BC,EAAE,EAAEH,MAAM,CAACI,SAAP,CAAiBC,OAAjB,CAAyB,YAAzB;IADyB,CAAjC;EAGH;EAED;;;;;EAGA,SAASJ,YAAT,CAAsBD,MAAtB,EAA4B;IACxB7B,YAAY,CAACmC,OAAb,CAAqBC,QAArB;;IAEA,SAASA,QAAT,CAAkBC,KAAlB,EAAuB;MACnBR,MAAM,CAACF,EAAP,CAAUU,KAAV,EAAiB,gBAAI;QACjBR,MAAM,CAACS,SAAP,CAAiBP,IAAjB,CAAsBM,KAAtB,EAA6BE,IAA7B;MACH,CAFD;IAGH;EACJ;;EAED,OAAOtB,EAAP;AACH,CAnED","names":["socket","require","utils","module","exports","plugin","server","clientEvents","bs","init","emitter","events","socketConfig","options","get","toJS","getIn","getServer","listen","registerCleanupTask","close","socketIoConfig","socketIoOptions","path","io","sockets","of","namespace","set","clients","heartbeatTimeout","origins","_","callback","on","handleConnection","client","addGhostMode","emit","ua","handshake","headers","forEach","addEvent","event","broadcast","data"],"sources":["../lib/sockets.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}