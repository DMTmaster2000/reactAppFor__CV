{"ast":null,"code":"\"use strict\";\n\nvar enableDestroy = require(\"server-destroy\");\n\nvar _ = require(\"../lodash.custom\");\n/**\n * Browsersync server\n * Three available modes: Snippet, Server or Proxy\n */\n\n\nmodule.exports.plugin = function (bs) {\n  var debug = bs.debug;\n  var proxy = bs.options.get(\"proxy\");\n  var type = bs.options.get(\"mode\");\n  var bsServer = createServer(bs);\n\n  if (type === \"server\" || type === \"snippet\") {\n    debug(\"Static Server running ({magenta:%s}) ...\", bs.options.get(\"scheme\"));\n  }\n\n  if (proxy) {\n    debug(\"Proxy running, proxing: {magenta:%s}\", proxy.get(\"target\"));\n  }\n\n  if (bsServer) {\n    /**\n     * Allow server to be destroyed gracefully\n     */\n    enableDestroy(bsServer.server);\n    /**\n     * Listen on the available port\n     */\n\n    bsServer.server.listen(bs.options.get(\"port\"), bs.options.get(\"listen\"));\n    /**\n     * Hack to deal with https://github.com/socketio/socket.io/issues/1602#issuecomment-224270022\n     */\n\n    bs.registerCleanupTask(function () {\n      if (bs.io && bs.io.sockets) {\n        setCloseReceived(bs.io.sockets);\n      }\n\n      if (bs.ui && bs.ui.socket) {\n        setCloseReceived(bs.ui.socket);\n      }\n    });\n    /**\n     * Destroy the server on cleanup\n     */\n\n    bs.registerCleanupTask(function () {\n      bsServer.server.destroy();\n    });\n  }\n\n  function setCloseReceived(io) {\n    Object.keys(io.sockets).forEach(function (key) {\n      _.set(io.sockets[key], \"conn.transport.socket._closeReceived\", true);\n    });\n  }\n\n  debug(\"Running mode: %s\", type.toUpperCase());\n  return {\n    server: bsServer.server,\n    app: bsServer.app\n  };\n};\n/**\n * Launch the server for serving the client JS plus static files\n * @param {BrowserSync} bs\n * @returns {{staticServer: (http.Server), proxyServer: (http.Server)}}\n */\n\n\nfunction createServer(bs) {\n  var proxy = bs.options.get(\"proxy\");\n  var server = bs.options.get(\"server\");\n\n  if (!proxy && !server) {\n    return require(\"./snippet-server\")(bs);\n  }\n\n  if (proxy) {\n    return require(\"./proxy-server\")(bs);\n  }\n\n  if (server) {\n    return require(\"./static-server\")(bs);\n  }\n}\n\nmodule.exports.createServer = createServer;","map":{"version":3,"mappings":"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","names":["enableDestroy","require","_","module","exports","plugin","bs","debug","proxy","options","get","type","bsServer","createServer","server","listen","registerCleanupTask","io","sockets","setCloseReceived","ui","socket","destroy","Object","keys","forEach","key","set","toUpperCase","app"],"sources":["../../lib/server/index.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}